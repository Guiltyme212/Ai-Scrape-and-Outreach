{% extends "base.html" %}
{% block title %}Dashboard — LeadPilot{% endblock %}

{% block content %}
<!-- Stats Bar -->
<div class="grid">
    <article>
        <header>Total Leads</header>
        <h2>{{ stats.total_leads }}</h2>
    </article>
    <article>
        <header>Analyzed</header>
        <h2>{{ stats.total_analyzed }}</h2>
    </article>
    <article>
        <header>Previews Ready</header>
        <h2>{{ stats.total_previews }}</h2>
    </article>
    <article>
        <header>Emails Sent</header>
        <h2>{{ stats.total_sent }}</h2>
    </article>
    <article>
        <header>Replies</header>
        <h2>{{ stats.total_replied }}</h2>
    </article>
    <article>
        <header>Closed</header>
        <h2>{{ stats.total_closed }}</h2>
    </article>
</div>

<!-- Actions -->
<div class="grid">
    <div>
        <details>
            <summary role="button">Run Pipeline</summary>
            <form method="post" action="/api/pipeline/run">
                <label>
                    Niche
                    <input type="text" name="niche" value="{{ settings.default_niche }}" placeholder="e.g. plumber">
                </label>
                <label>
                    Location
                    <input type="text" name="location" value="{{ settings.default_location }}" placeholder="e.g. Amsterdam, Netherlands">
                </label>
                <label>
                    Limit
                    <input type="number" name="limit" value="15" min="1" max="100">
                </label>
                <button type="submit">Start Scraping</button>
            </form>
        </details>
    </div>
    <div>
        <form method="post" action="/api/batch/send" style="display:inline">
            <button type="submit" class="secondary">Send All Drafted Emails</button>
        </form>
    </div>
</div>

<!-- Filters -->
<details>
    <summary>Filters</summary>
    <form method="get" action="/dashboard">
        <div class="grid">
            <label>
                Campaign
                <select name="campaign_id">
                    <option value="">All campaigns</option>
                    {% for c in campaigns %}
                    <option value="{{ c.id }}" {% if filters.campaign_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Status
                <select name="status">
                    <option value="">All statuses</option>
                    <option value="scraped" {% if filters.status == 'scraped' %}selected{% endif %}>Scraped</option>
                    <option value="analyzed" {% if filters.status == 'analyzed' %}selected{% endif %}>Analyzed</option>
                    <option value="preview_ready" {% if filters.status == 'preview_ready' %}selected{% endif %}>Preview Ready</option>
                    <option value="email_drafted" {% if filters.status == 'email_drafted' %}selected{% endif %}>Email Drafted</option>
                    <option value="sent" {% if filters.status == 'sent' %}selected{% endif %}>Sent</option>
                    <option value="responded" {% if filters.status == 'responded' %}selected{% endif %}>Responded</option>
                    <option value="closed" {% if filters.status == 'closed' %}selected{% endif %}>Closed</option>
                </select>
            </label>
            <label>
                Max Score
                <input type="number" name="score_max" value="{{ filters.score_max or '' }}" placeholder="e.g. 50" min="0" max="100">
            </label>
        </div>
        <button type="submit" class="outline">Apply Filters</button>
    </form>
</details>

<!-- Leads Table -->
<figure>
    <table role="grid">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Business Name</th>
                <th scope="col">Type</th>
                <th scope="col">City</th>
                <th scope="col">Score</th>
                <th scope="col">Preview</th>
                <th scope="col">Email</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <td>{{ lead.id }}</td>
                <td><a href="/leads/{{ lead.id }}">{{ lead.business_name }}</a></td>
                <td>{{ lead.business_type }}</td>
                <td>{{ lead.city }}</td>
                <td>
                    {% if lead.site_score is not none %}
                        <span class="score-badge score-{{ 'low' if lead.site_score < 30 else ('mid' if lead.site_score < 60 else 'high') }}">
                            {{ lead.site_score }}
                        </span>
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>
                    {% if lead.preview_status == 'ready' %}
                        <a href="{{ lead.preview_url }}" target="_blank">View</a>
                    {% else %}
                        {{ lead.preview_status }}
                    {% endif %}
                </td>
                <td>
                    <span class="email-status email-{{ lead.email_status }}">{{ lead.email_status }}</span>
                </td>
                <td>
                    <span class="status-badge status-{{ lead.status }}">{{ lead.status }}</span>
                </td>
                <td>
                    <a href="/leads/{{ lead.id }}" role="button" class="outline small-btn">View</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" style="text-align:center; padding: 2rem;">
                    No leads yet. Run the pipeline to get started!
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</figure>
{% endblock %}
