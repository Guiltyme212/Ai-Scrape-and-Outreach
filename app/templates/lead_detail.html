{% extends "base.html" %}
{% block title %}{{ lead.business_name }} — LeadPilot{% endblock %}

{% block content %}
<hgroup>
    <h2>{{ lead.business_name }}</h2>
    <p>{{ lead.business_type }} in {{ lead.city }} — Status: <strong>{{ lead.status }}</strong></p>
</hgroup>

<!-- Business Info -->
<div class="grid">
    <article>
        <header>Business Info</header>
        <dl>
            <dt>Address</dt>
            <dd>{{ lead.address or '—' }}</dd>
            <dt>Phone</dt>
            <dd>{{ lead.phone or '—' }}</dd>
            <dt>Email</dt>
            <dd>{{ lead.email or '—' }}</dd>
            <dt>Website</dt>
            <dd>
                {% if lead.website_url %}
                    <a href="{{ lead.website_url }}" target="_blank">{{ lead.website_url }}</a>
                {% else %}
                    No website
                {% endif %}
            </dd>
            <dt>Google Rating</dt>
            <dd>{{ lead.rating or '—' }} ({{ lead.reviews_count or 0 }} reviews)</dd>
        </dl>
    </article>
    <article>
        <header>Analysis Score</header>
        {% if lead.site_score is not none %}
            <h1 class="score-badge score-{{ 'low' if lead.site_score < 30 else ('mid' if lead.site_score < 60 else 'high') }}" style="font-size:3rem; text-align:center; display:block; padding:0.5rem;">
                {{ lead.site_score }}/100
            </h1>
            <p>{{ lead.analysis_summary or '' }}</p>
        {% else %}
            <p>Not yet analyzed</p>
        {% endif %}
    </article>
</div>

<!-- Screenshot vs Preview -->
<div class="grid">
    <article>
        <header>Current Website Screenshot</header>
        {% if lead.screenshot_url %}
            <img src="{{ lead.screenshot_url }}" alt="Screenshot of {{ lead.business_name }}" style="width:100%; border-radius:4px;">
        {% else %}
            <p>No screenshot available</p>
        {% endif %}
    </article>
    <article>
        <header>Preview Redesign</header>
        {% if lead.preview_url and lead.preview_status == 'ready' %}
            <p><a href="{{ lead.preview_url }}" target="_blank" role="button">Open Preview Site</a></p>
            <small>{{ lead.preview_url }}</small>
        {% elif lead.preview_status == 'generating' %}
            <p aria-busy="true">Generating preview...</p>
        {% elif lead.preview_status == 'failed' %}
            <p>Preview generation failed</p>
        {% else %}
            <p>No preview generated yet</p>
        {% endif %}
    </article>
</div>

<!-- Issues -->
{% if issues %}
<article>
    <header>Issues Found</header>
    <ul>
        {% for issue in issues %}
        <li>{{ issue }}</li>
        {% endfor %}
    </ul>
</article>
{% endif %}

<!-- Email Draft -->
<article>
    <header>Email Draft</header>
    {% if lead.email_body %}
        <form method="post" action="/api/leads/{{ lead.id }}/update-email">
            <label>
                Subject
                <input type="text" name="subject" value="{{ lead.email_subject or '' }}">
            </label>
            <label>
                Body
                <textarea name="body" rows="10">{{ lead.email_body }}</textarea>
            </label>
            <div class="grid">
                <button type="submit" class="secondary">Save Changes</button>
                {% if lead.email_status == 'draft' %}
                <form method="post" action="/api/leads/{{ lead.id }}/send" style="display:inline">
                    <button type="submit">Send Email</button>
                </form>
                {% endif %}
            </div>
        </form>
        <p>
            <small>Status: <strong>{{ lead.email_status }}</strong>
            {% if lead.email_sent_at %} — Sent at {{ lead.email_sent_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
            </small>
        </p>
    {% else %}
        <p>No email drafted yet</p>
    {% endif %}
</article>

<!-- Activity Timeline -->
<article>
    <header>Activity Timeline</header>
    <ul class="timeline">
        <li class="{% if lead.status %}done{% endif %}">Scraped — {{ lead.created_at.strftime('%Y-%m-%d %H:%M') if lead.created_at else '' }}</li>
        <li class="{% if lead.site_score is not none %}done{% endif %}">Analyzed{% if lead.site_score is not none %} — Score: {{ lead.site_score }}{% endif %}</li>
        <li class="{% if lead.preview_status == 'ready' %}done{% endif %}">Preview {{ lead.preview_status }}</li>
        <li class="{% if lead.email_body %}done{% endif %}">Email {{ lead.email_status }}</li>
        {% if lead.email_sent_at %}
        <li class="done">Sent — {{ lead.email_sent_at.strftime('%Y-%m-%d %H:%M') }}</li>
        {% endif %}
    </ul>
</article>

<!-- Actions -->
<div class="grid">
    <form method="post" action="/api/leads/{{ lead.id }}/reprocess">
        <button type="submit" class="outline">Re-process Lead</button>
    </form>
    <a href="/" role="button" class="secondary outline">Back to Dashboard</a>
</div>
{% endblock %}
